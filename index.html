<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VidDrop</title>
  <meta name="description" content="VidDrop — Clean, local YouTube downloader with a beautiful glassmorphism UI.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
    rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    /* ─── Reset & Custom Properties ──────────────────────── */
    *,
    *::before,
    *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #0d0d18;
      --accent-primary: #6366f1;
      --accent-secondary: #8b5cf6;
      --accent-glow: rgba(99, 102, 241, 0.25);
      --accent-success: #10b981;
      --accent-warning: #f59e0b;
      --accent-error: #ef4444;
      --glass-bg: rgba(255, 255, 255, 0.04);
      --glass-border: rgba(255, 255, 255, 0.08);
      --glass-hover: rgba(255, 255, 255, 0.07);
      --glass-strong: rgba(255, 255, 255, 0.06);
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #475569;
      --text-accent: #818cf8;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --blur: blur(20px) saturate(180%);
      --transition: all 0.2s ease;
    }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: linear-gradient(135deg, #0a0a0f 0%, #0d1117 50%, #0a0a1a 100%);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      line-height: 1.6;
      font-size: 15px;
      -webkit-font-smoothing: antialiased;
    }

    .hidden {
      display: none !important;
    }

    /* ─── Background Orbs ────────────────────────────────── */
    .orb {
      position: fixed;
      border-radius: 50%;
      pointer-events: none;
      z-index: 0;
    }

    .orb-1 {
      width: 600px;
      height: 600px;
      top: -200px;
      left: -200px;
      background: radial-gradient(circle, rgba(99, 102, 241, 0.12) 0%, transparent 70%);
      filter: blur(40px);
    }

    .orb-2 {
      width: 500px;
      height: 500px;
      bottom: -150px;
      right: -150px;
      background: radial-gradient(circle, rgba(139, 92, 246, 0.10) 0%, transparent 70%);
      filter: blur(40px);
    }

    .orb-3 {
      width: 800px;
      height: 800px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: radial-gradient(circle, rgba(99, 102, 241, 0.04) 0%, transparent 60%);
      filter: blur(40px);
    }

    /* ─── Layout ──────────────────────────────────────────── */
    .container {
      max-width: 680px;
      width: 100%;
      margin: 0 auto;
      padding: 40px 20px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      position: relative;
      z-index: 1;
    }

    /* ─── Glass Cards ─────────────────────────────────────── */
    .glass-card {
      position: relative;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.06);
    }

    .glass-card::before {
      content: "";
      position: absolute;
      top: 0;
      left: 20px;
      right: 20px;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.12), transparent);
      border-radius: 999px;
      pointer-events: none;
    }

    .glass-card-elevated {
      position: relative;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(255, 255, 255, 0.06), inset 0 1px 0 rgba(255, 255, 255, 0.08);
    }

    .glass-card-elevated::before {
      content: "";
      position: absolute;
      top: 0;
      left: 20px;
      right: 20px;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.12), transparent);
      border-radius: 999px;
      pointer-events: none;
    }

    .glass-panel {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      transition: var(--transition);
    }

    .glass-panel:hover {
      background: var(--glass-hover);
      border-color: rgba(99, 102, 241, 0.3);
      box-shadow: 0 0 20px rgba(99, 102, 241, 0.15);
    }

    /* ─── Buttons ─────────────────────────────────────────── */
    button {
      cursor: pointer;
      border: none;
      font-family: inherit;
      transition: var(--transition);
    }

    button:active {
      transform: scale(0.97);
    }

    .glass-btn-primary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: var(--text-primary);
      height: 56px;
      border-radius: 14px;
      font-weight: 600;
      font-size: 15px;
      padding: 0 24px;
      width: 100%;
      box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
    }

    .glass-btn-primary:hover {
      box-shadow: 0 4px 30px rgba(99, 102, 241, 0.6);
      transform: translateY(-1px);
    }

    .glass-btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .glass-btn-ghost {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid var(--glass-border);
      border-radius: 10px;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 500;
    }

    .glass-btn-ghost:hover {
      background: var(--glass-hover);
      color: var(--text-primary);
      border-color: rgba(99, 102, 241, 0.3);
    }

    .glass-btn-accent {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: rgba(99, 102, 241, 0.2);
      border: 1px solid rgba(99, 102, 241, 0.3);
      color: var(--text-accent);
      border-radius: var(--radius-sm);
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 500;
    }

    .glass-btn-accent:hover {
      background: rgba(99, 102, 241, 0.3);
    }

    /* ─── Input ───────────────────────────────────────────── */
    .input-wrapper {
      position: relative;
      max-width: 640px;
      margin: 0 auto;
      width: 100%;
    }

    .glass-input {
      width: 100%;
      height: 56px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.10);
      border-radius: 14px;
      padding: 0 120px 0 20px;
      font-size: 16px;
      color: var(--text-primary);
      font-family: inherit;
      outline: none;
      transition: var(--transition);
    }

    .glass-input::placeholder {
      color: var(--text-muted);
    }

    .glass-input:focus {
      border-color: rgba(99, 102, 241, 0.6);
      animation: focusGlow 2s ease infinite;
    }

    .glass-input:read-only {
      opacity: 0.7;
      cursor: default;
    }

    .paste-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      height: 38px;
      padding: 0 16px;
      background: rgba(99, 102, 241, 0.2);
      border: 1px solid rgba(99, 102, 241, 0.3);
      border-radius: var(--radius-sm);
      color: var(--text-accent);
      font-size: 13px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .paste-btn:hover {
      background: rgba(99, 102, 241, 0.3);
    }

    .input-indicator {
      position: absolute;
      right: 110px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--accent-success);
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .input-indicator.visible {
      opacity: 1;
    }

    .inline-error {
      color: var(--accent-error);
      font-size: 13px;
      margin-top: 8px;
      text-align: center;
    }

    /* ─── Title ───────────────────────────────────────────── */
    .app-title {
      font-size: 32px;
      font-weight: 700;
      letter-spacing: -0.02em;
      text-align: center;
      background: linear-gradient(135deg, #6366f1, #a78bfa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .app-subtitle {
      color: var(--text-secondary);
      font-size: 15px;
      text-align: center;
      margin-top: 4px;
    }

    /* ─── Video Info Card ─────────────────────────────────── */
    .video-card {
      display: flex;
      gap: 16px;
      padding: 20px;
    }

    .video-thumb {
      width: 160px;
      min-width: 160px;
      height: 90px;
      border-radius: 10px;
      object-fit: cover;
      border: 1px solid var(--glass-border);
      background: var(--bg-secondary);
    }

    .video-info {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .video-title {
      font-size: 16px;
      font-weight: 600;
      letter-spacing: -0.01em;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .video-channel {
      font-size: 13px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .video-channel i {
      width: 14px;
      height: 14px;
    }

    .duration-badge {
      display: inline-flex;
      align-items: center;
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      color: var(--text-accent);
      background: var(--glass-bg);
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--glass-border);
      width: fit-content;
    }

    /* ─── Tab System ──────────────────────────────────────── */
    .tab-bar {
      display: flex;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 10px;
      padding: 4px;
      gap: 4px;
    }

    .tab-btn {
      flex: 1;
      height: 36px;
      border-radius: 7px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .tab-btn i {
      width: 16px;
      height: 16px;
    }

    .tab-btn.active {
      background: rgba(99, 102, 241, 0.2);
      color: var(--text-accent);
      border: 1px solid rgba(99, 102, 241, 0.3);
    }

    .tab-content {
      padding: 12px 0;
      transition: opacity 0.15s ease;
    }

    /* ─── Format Rows ─────────────────────────────────────── */
    .format-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 0 16px 16px;
    }

    .format-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .format-row:hover {
      background: rgba(255, 255, 255, 0.06);
    }

    .format-row-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .format-row-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .quality-badge {
      background: rgba(99, 102, 241, 0.15);
      border: 1px solid rgba(99, 102, 241, 0.25);
      border-radius: 6px;
      padding: 3px 10px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-accent);
      white-space: nowrap;
    }

    .format-label {
      font-size: 14px;
      color: var(--text-primary);
    }

    .format-size {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--text-muted);
    }

    .download-icon {
      color: var(--text-secondary);
      opacity: 0.3;
      transition: opacity 0.2s ease, color 0.2s ease, transform 0.2s ease;
    }

    .download-icon i {
      width: 16px;
      height: 16px;
    }

    .format-row:hover .download-icon {
      opacity: 1;
      color: var(--accent-primary);
      transform: translateY(2px);
    }

    .format-row-disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .format-row-disabled:hover {
      background: transparent;
    }

    .format-row-disabled:hover .download-icon {
      opacity: 0.3;
      color: var(--text-secondary);
      transform: none;
    }

    /* ─── Thumbnail Cards ─────────────────────────────────── */
    .thumb-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 0 16px 16px;
    }

    .thumb-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
    }

    .thumb-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .thumb-label {
      font-size: 15px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .thumb-dims {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--text-muted);
    }

    .thumb-dl-btn {
      padding: 8px 16px;
      font-size: 13px;
      min-width: 100px;
    }

    /* ─── Progress ────────────────────────────────────────── */
    .progress-section {
      padding: 32px 24px;
      text-align: center;
    }

    .progress-title {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 4px;
      word-break: break-word;
    }

    .progress-format {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 20px;
    }

    .progress-bar {
      height: 4px;
      background: rgba(255, 255, 255, 0.06);
      border-radius: 999px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .progress-fill {
      height: 100%;
      border-radius: 999px;
      transition: width 0.3s ease;
      background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 50%, #6366f1 100%);
      background-size: 200% 100%;
      animation: shimmer 2s linear infinite;
      box-shadow: 0 0 10px rgba(99, 102, 241, 0.6);
      width: 0%;
    }

    .progress-stats {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .progress-percent {
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      color: var(--text-accent);
    }

    .progress-status {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .cancel-btn {
      margin-top: 8px;
    }

    /* ─── Success State ───────────────────────────────────── */
    .success-section {
      padding: 40px 24px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }

    .success-check {
      width: 64px;
      height: 64px;
      color: var(--accent-success);
    }

    .success-check circle {
      stroke: var(--accent-success);
      fill: none;
      stroke-width: 2;
    }

    .success-check path,
    .success-check polyline {
      stroke: var(--accent-success);
      fill: none;
      stroke-width: 2;
    }

    .checkmark-active .checkmark-circle {
      stroke-dasharray: 200;
      stroke-dashoffset: 200;
      animation: checkDraw 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    .checkmark-active .checkmark-path {
      stroke-dasharray: 50;
      stroke-dashoffset: 50;
      animation: checkDraw 0.4s cubic-bezier(0.16, 1, 0.3, 1) 0.3s forwards;
    }

    .success-heading {
      font-size: 20px;
      font-weight: 600;
      letter-spacing: -0.01em;
    }

    .success-filename {
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      color: var(--text-secondary);
      word-break: break-all;
    }

    .success-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 8px;
    }

    /* ─── Error State ─────────────────────────────────────── */
    .error-section {
      padding: 40px 24px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }

    .error-icon {
      color: var(--accent-error);
    }

    .error-icon i {
      width: 48px;
      height: 48px;
    }

    .error-heading {
      font-size: 20px;
      font-weight: 600;
    }

    .error-message {
      font-size: 14px;
      color: var(--text-secondary);
      max-width: 400px;
    }

    /* ─── Warning Banners ─────────────────────────────────── */
    .warning-banner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
    }

    .companion-banner {
      background: rgba(239, 68, 68, 0.1);
      border-bottom: 1px solid rgba(239, 68, 68, 0.2);
      color: var(--text-primary);
    }

    .companion-banner i {
      color: var(--accent-error);
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    .ffmpeg-banner {
      background: rgba(245, 158, 11, 0.1);
      border-bottom: 1px solid rgba(245, 158, 11, 0.2);
      color: var(--text-primary);
    }

    .ffmpeg-banner i {
      color: var(--accent-warning);
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    .banner-code {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      background: var(--glass-bg);
      padding: 2px 8px;
      border-radius: 6px;
      border: 1px solid var(--glass-border);
    }

    /* ─── Setup Overlay ───────────────────────────────────── */
    .setup-overlay {
      position: fixed;
      inset: 0;
      z-index: 200;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      transition: opacity 0.3s ease;
    }

    .setup-card {
      max-width: 520px;
      width: 100%;
      padding: 32px;
    }

    .setup-icon {
      color: var(--accent-warning);
      margin-bottom: 16px;
      text-align: center;
    }

    .setup-icon i {
      width: 48px;
      height: 48px;
    }

    .setup-heading {
      font-size: 20px;
      font-weight: 600;
      text-align: center;
      margin-bottom: 8px;
    }

    .setup-desc {
      font-size: 14px;
      color: var(--text-secondary);
      text-align: center;
      margin-bottom: 24px;
    }

    .setup-steps {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 24px;
    }

    .setup-step {
      display: flex;
      gap: 12px;
    }

    .step-num {
      width: 24px;
      height: 24px;
      min-width: 24px;
      border-radius: 50%;
      background: rgba(99, 102, 241, 0.2);
      border: 1px solid rgba(99, 102, 241, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-accent);
    }

    .step-text {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .step-text a {
      color: var(--accent-primary);
      text-decoration: none;
    }

    .step-text a:hover {
      text-decoration: underline;
    }

    .setup-status {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .pulse-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent-warning);
      animation: pulse 2s ease infinite;
    }

    /* ─── Toast ────────────────────────────────────────────── */
    #toast-container {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 300;
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
      pointer-events: none;
    }

    .toast {
      pointer-events: auto;
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 14px;
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      border: 1px solid var(--glass-border);
      animation: slideUp 0.25s ease;
      white-space: nowrap;
    }

    .toast-info {
      background: rgba(99, 102, 241, 0.15);
      color: var(--text-accent);
    }

    .toast-success {
      background: rgba(16, 185, 129, 0.15);
      color: var(--accent-success);
    }

    .toast-warning {
      background: rgba(245, 158, 11, 0.15);
      color: var(--accent-warning);
    }

    .toast-error {
      background: rgba(239, 68, 68, 0.15);
      color: var(--accent-error);
    }

    .toast-hiding {
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.25s ease;
    }

    /* ─── Loading ──────────────────────────────────────────── */
    .loading-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      margin-top: 16px;
    }

    .loading-area i {
      width: 24px;
      height: 24px;
      color: var(--accent-primary);
    }

    .loading-text {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* ─── Animations ──────────────────────────────────────── */
    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @keyframes shake {

      0%,
      100% {
        transform: translateX(0);
      }

      25% {
        transform: translateX(-8px);
      }

      75% {
        transform: translateX(8px);
      }
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.4;
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes checkDraw {
      to {
        stroke-dashoffset: 0;
      }
    }

    @keyframes shimmer {
      0% {
        background-position: -200% 0;
      }

      100% {
        background-position: 200% 0;
      }
    }

    @keyframes focusGlow {

      0%,
      100% {
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
      }

      50% {
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.30);
      }
    }

    .animate-fade-up {
      animation: fadeUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .animate-spin {
      animation: spin 1s linear infinite;
    }

    .animate-shake {
      animation: shake 0.3s ease;
    }

    .animate-pulse {
      animation: pulse 2s ease infinite;
    }

    .stagger-1 {
      animation-delay: 40ms;
    }

    .stagger-2 {
      animation-delay: 80ms;
    }

    .stagger-3 {
      animation-delay: 120ms;
    }

    .stagger-4 {
      animation-delay: 160ms;
    }

    .stagger-5 {
      animation-delay: 200ms;
    }

    .stagger-6 {
      animation-delay: 240ms;
    }

    .stagger-7 {
      animation-delay: 280ms;
    }

    .stagger-8 {
      animation-delay: 320ms;
    }

    /* ─── Responsive ──────────────────────────────────────── */
    @media (max-width: 640px) {
      .container {
        padding: 20px 16px;
      }

      .video-card {
        flex-direction: column;
      }

      .video-thumb {
        width: 100%;
        height: auto;
        aspect-ratio: 16/9;
      }

      .tab-label {
        display: none;
      }

      .format-size {
        display: none;
      }

      .success-buttons {
        flex-direction: column;
        width: 100%;
      }

      .success-buttons button {
        width: 100%;
      }
    }
  </style>
</head>

<body>

  <!-- Background Orbs -->
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="orb orb-3"></div>

  <!-- ffmpeg Warning Banner -->
  <div id="ffmpeg-banner" class="warning-banner ffmpeg-banner hidden">
    <i data-lucide="alert-triangle"></i>
    <span>ffmpeg not found — MP3 conversion disabled. Install <span class="banner-code">ffmpeg</span> to enable audio
      conversion.</span>
  </div>

  <!-- Main Container -->
  <div class="container">

    <!-- STATE 0: IDLE + STATE 1: LOADING -->
    <div id="state-input">
      <div style="text-align:center; margin-bottom:24px; margin-top:20px;">
        <h1 class="app-title">VidDrop</h1>
        <p class="app-subtitle">Paste a YouTube link, pick a format, download.</p>
      </div>
      <div class="input-wrapper">
        <input type="text" id="url-input" class="glass-input" placeholder="https://youtube.com/watch?v=..."
          autocomplete="off" spellcheck="false">
        <div id="input-indicator" class="input-indicator"><i data-lucide="check-circle-2"
            style="width:18px;height:18px;"></i></div>
        <button id="paste-btn" class="paste-btn" type="button"><i data-lucide="clipboard"
            style="width:14px;height:14px;"></i><span>Paste</span></button>
      </div>
      <div id="inline-error" class="inline-error hidden"></div>
      <div style="max-width:640px;margin:12px auto 0;width:100%;">
        <button id="fetch-btn" class="glass-btn-primary" type="button">
          <i data-lucide="search" style="width:18px;height:18px;"></i>
          <span id="fetch-btn-text">Fetch Video Info</span>
        </button>
      </div>
      <div id="loading-area" class="loading-area hidden">
        <i data-lucide="loader-2" class="animate-spin"></i>
        <span id="loading-text" class="loading-text">Fetching video info...</span>
      </div>
    </div>

    <!-- STATE 2: READY -->
    <div id="state-ready" class="hidden">
      <div class="glass-card-elevated">
        <div class="video-card">
          <img id="video-thumb" class="video-thumb" src="" alt="">
          <div class="video-info">
            <div id="video-title" class="video-title"></div>
            <div class="video-channel"><i data-lucide="user" style="width:14px;height:14px;"></i><span
                id="video-channel"></span></div>
            <div id="video-duration" class="duration-badge"></div>
          </div>
        </div>
        <div style="padding:0 16px 4px;">
          <div class="tab-bar">
            <button class="tab-btn active" data-tab="video"><i data-lucide="video"></i><span
                class="tab-label">VIDEO</span></button>
            <button class="tab-btn" data-tab="audio"><i data-lucide="music"></i><span
                class="tab-label">AUDIO</span></button>
            <button class="tab-btn" data-tab="thumbnail"><i data-lucide="image"></i><span
                class="tab-label">THUMBNAIL</span></button>
          </div>
        </div>
        <div id="tab-video-content" class="tab-content">
          <div id="video-format-list" class="format-list"></div>
        </div>
        <div id="tab-audio-content" class="tab-content hidden">
          <div id="audio-format-list" class="format-list"></div>
        </div>
        <div id="tab-thumb-content" class="tab-content hidden">
          <div id="thumb-options" class="thumb-options"></div>
        </div>
      </div>
    </div>

    <!-- STATE 3: DOWNLOADING -->
    <div id="state-downloading" class="hidden">
      <div class="glass-card">
        <div class="progress-section">
          <div id="dl-filename" class="progress-title"></div>
          <div id="dl-format" class="progress-format"></div>
          <div class="progress-bar">
            <div id="progress-fill" class="progress-fill"></div>
          </div>
          <div class="progress-stats">
            <span id="progress-percent" class="progress-percent">0%</span>
            <span id="status-text" class="progress-status">Starting...</span>
          </div>
          <button id="cancel-btn" class="glass-btn-ghost cancel-btn" type="button">
            <i data-lucide="x" style="width:16px;height:16px;"></i><span>Cancel</span>
          </button>
        </div>
      </div>
    </div>

    <!-- STATE 4: DONE -->
    <div id="state-done" class="hidden">
      <div class="glass-card">
        <div class="success-section">
          <svg id="success-svg" class="success-check" viewBox="0 0 64 64" fill="none">
            <circle class="checkmark-circle" cx="32" cy="32" r="29" stroke-width="2" />
            <polyline class="checkmark-path" points="20,34 28,42 44,24" stroke-width="3" stroke-linecap="round"
              stroke-linejoin="round" />
          </svg>
          <div class="success-heading">Downloaded successfully!</div>
          <div id="done-filename" class="success-filename"></div>
          <div class="success-buttons">
            <button id="btn-another" class="glass-btn-primary" type="button" style="height:44px;font-size:14px;">
              <i data-lucide="plus" style="width:16px;height:16px;"></i>Download Another
            </button>
            <button id="btn-same" class="glass-btn-ghost" type="button">
              <i data-lucide="repeat" style="width:16px;height:16px;"></i>Download Same Video
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- STATE ERROR -->
    <div id="state-error" class="hidden">
      <div class="glass-card">
        <div class="error-section">
          <div class="error-icon"><i data-lucide="x-circle"></i></div>
          <div class="error-heading">Something went wrong</div>
          <div id="error-message" class="error-message"></div>
          <button id="btn-tryagain" class="glass-btn-primary" type="button"
            style="height:44px;font-size:14px;max-width:200px;">
            <i data-lucide="refresh-cw" style="width:16px;height:16px;"></i>Try Again
          </button>
        </div>
      </div>
    </div>

  </div><!-- /container -->

  <!-- Setup Overlay -->
  <div id="setup-overlay" class="setup-overlay hidden">
    <div class="setup-card glass-card">
      <div class="setup-icon"><i data-lucide="alert-triangle"></i></div>
      <div class="setup-heading">Start the Companion First</div>
      <div class="setup-desc">VidDrop needs its companion server running to download videos.</div>
      <div class="setup-steps">
        <div class="setup-step">
          <div class="step-num">1</div>
          <div class="step-text">Install <a href="https://python.org" target="_blank">Python 3.8+</a></div>
        </div>
        <div class="setup-step">
          <div class="step-num">2</div>
          <div class="step-text">Open a terminal in the VidDrop folder</div>
        </div>
        <div class="setup-step">
          <div class="step-num">3</div>
          <div class="step-text">Run: <span class="banner-code">python companion.py</span></div>
        </div>
        <div class="setup-step">
          <div class="step-num">4</div>
          <div class="step-text">Return here — it auto-detects the server</div>
        </div>
      </div>
      <div class="setup-status">
        <div class="pulse-dot"></div>
        <span id="setup-status-text">Waiting for companion...</span>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toast-container"></div>

  <script>
    /* ═══════════════════════════════════════════════════════════
       VidDrop Frontend — Complete JavaScript
       ═══════════════════════════════════════════════════════════ */

    const API_BASE = "http://localhost:7701";

    const STATES = {
      IDLE: "idle", LOADING: "loading", READY: "ready",
      DOWNLOADING: "downloading", DONE: "done", ERROR: "error"
    };

    let currentState = STATES.IDLE;

    // Window-level state
    window.videoData = null;
    window.currentURL = null;
    window.downloadInProgress = false;
    window.ffmpegAvailable = false;
    window.currentJobId = null;
    window.currentEventSource = null;
    window.abortController = null;

    // ─── State Machine ───────────────────────────────────────
    function setState(newState) {
      currentState = newState;
      const ids = ["state-input", "state-ready", "state-downloading", "state-done", "state-error"];
      ids.forEach(id => document.getElementById(id).classList.add("hidden"));
      const map = {
        [STATES.IDLE]: "state-input", [STATES.LOADING]: "state-input",
        [STATES.READY]: "state-ready", [STATES.DOWNLOADING]: "state-downloading",
        [STATES.DONE]: "state-done", [STATES.ERROR]: "state-error"
      };
      const el = document.getElementById(map[newState]);
      el.classList.remove("hidden");
      el.classList.add("animate-fade-up");
      setTimeout(() => el.classList.remove("animate-fade-up"), 500);
      if (newState === STATES.LOADING) showLoadingInInput();
      if (newState === STATES.IDLE) resetInputField();
    }

    // ─── Companion Check ─────────────────────────────────────
    let retryCount = 0;
    let retryInterval = null;

    async function checkCompanion() {
      try {
        const resp = await fetch(API_BASE + "/ping", {
          method: "GET", signal: AbortSignal.timeout(3000)
        });
        const data = await resp.json();
        if (data.status === "ok") {
          window.ffmpegAvailable = data.ffmpeg;
          if (!data.ffmpeg) showFFmpegBanner();
          else hideFFmpegBanner();
          if (retryInterval) { clearInterval(retryInterval); retryInterval = null; }
          hideSetupOverlay();
          setState(STATES.IDLE);
          const inp = document.getElementById("url-input");
          if (inp) inp.focus();
          return;
        }
      } catch (e) { /* companion not reachable */ }
      retryCount++;
      showSetupOverlay();
      const statusEl = document.getElementById("setup-status-text");
      if (statusEl) statusEl.textContent = "Waiting for companion... (attempt " + retryCount + ")";
    }

    // ─── URL Validation ──────────────────────────────────────
    function isValidYouTubeURL(url) {
      return /(?:youtube\.com\/watch\?.*v=|youtu\.be\/|youtube\.com\/shorts\/|youtube\.com\/embed\/|m\.youtube\.com\/watch\?.*v=)/.test(url);
    }

    function extractVideoId(url) {
      const patterns = [
        /[?&]v=([a-zA-Z0-9_-]{11})/, /youtu\.be\/([a-zA-Z0-9_-]{11})/,
        /\/shorts\/([a-zA-Z0-9_-]{11})/, /\/embed\/([a-zA-Z0-9_-]{11})/
      ];
      for (const p of patterns) { const m = url.match(p); if (m) return m[1]; }
      return null;
    }

    // ─── Fetch Video Info ─────────────────────────────────────
    async function fetchVideoInfo(url) {
      setState(STATES.LOADING);
      try {
        const resp = await fetch(API_BASE + "/info?url=" + encodeURIComponent(url));
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || "Failed to fetch video info.");
        window.videoData = data;
        window.currentURL = url;
        // Preload thumbnail
        if (data.thumbnail) { const img = new Image(); img.src = data.thumbnail; }
        renderVideoCard(data);
        setState(STATES.READY);
      } catch (err) {
        showError(err.message || "Failed to fetch video info.");
        setState(STATES.ERROR);
      } finally {
        hideLoadingInInput();
      }
    }

    // ─── Input Handlers ──────────────────────────────────────
    function handleSubmit() {
      const inp = document.getElementById("url-input");
      const url = inp.value.trim();
      if (!url || !isValidYouTubeURL(url)) {
        shakeInput(); showInlineError("Please enter a valid YouTube URL"); return;
      }
      hideInlineError();
      fetchVideoInfo(url);
    }

    function shakeInput() {
      const inp = document.getElementById("url-input");
      inp.classList.add("animate-shake");
      setTimeout(() => inp.classList.remove("animate-shake"), 300);
    }

    function showInlineError(msg) {
      const el = document.getElementById("inline-error");
      el.textContent = msg; el.classList.remove("hidden");
    }

    function hideInlineError() { document.getElementById("inline-error").classList.add("hidden"); }

    function showLoadingInInput() {
      document.getElementById("loading-area").classList.remove("hidden");
      document.getElementById("url-input").readOnly = true;
      document.getElementById("fetch-btn").disabled = true;
    }

    function hideLoadingInInput() {
      document.getElementById("loading-area").classList.add("hidden");
      document.getElementById("url-input").readOnly = false;
      document.getElementById("fetch-btn").disabled = false;
    }

    function resetInputField() {
      const inp = document.getElementById("url-input");
      inp.value = ""; inp.readOnly = false;
      document.getElementById("fetch-btn").disabled = false;
      document.getElementById("input-indicator").classList.remove("visible");
      hideInlineError(); hideLoadingInInput();
    }

    // ─── Render Video Card ────────────────────────────────────
    function renderVideoCard(data) {
      document.getElementById("video-thumb").src = data.thumbnail || "";
      document.getElementById("video-thumb").alt = data.title || "";
      document.getElementById("video-title").textContent = data.title || "Untitled";
      document.getElementById("video-channel").textContent = data.uploader || "Unknown";
      document.getElementById("video-duration").textContent = data.duration || "0:00";
      renderVideoFormats(data.video_formats || []);
      renderAudioFormats(data.audio_formats || []);
      renderThumbnailOptions(data.video_id || "");
      // Reset tabs to video
      switchTab("video");
      lucide.createIcons();
    }

    function sanitizeText(str) {
      return str.replace(/</g, "").replace(/>/g, "").replace(/&/g, "");
    }

    function renderVideoFormats(formats) {
      const container = document.getElementById("video-format-list");
      container.innerHTML = "";
      if (!formats.length) {
        const empty = document.createElement("div");
        empty.style.cssText = "padding:20px;text-align:center;color:var(--text-muted);font-size:14px;";
        empty.textContent = "No video formats found for this video";
        container.appendChild(empty); return;
      }
      formats.forEach((fmt, i) => {
        const row = document.createElement("div");
        row.className = "format-row glass-panel animate-fade-up stagger-" + Math.min(i + 1, 8);
        row.innerHTML = '<div class="format-row-left"><span class="quality-badge"></span><span class="format-label"></span></div>'
          + '<div class="format-row-right"><span class="format-size"></span><div class="download-icon"><i data-lucide="download"></i></div></div>';
        row.querySelector(".quality-badge").textContent = fmt.label;
        row.querySelector(".format-label").textContent = "MP4";
        row.querySelector(".format-size").textContent = fmt.size;
        row.addEventListener("click", () => startDownload(fmt.format_id, "video", "mp4", null));
        container.appendChild(row);
      });
      lucide.createIcons();
    }

    function renderAudioFormats(formats) {
      const container = document.getElementById("audio-format-list");
      container.innerHTML = "";
      if (!formats.length) {
        const empty = document.createElement("div");
        empty.style.cssText = "padding:20px;text-align:center;color:var(--text-muted);font-size:14px;";
        empty.textContent = "No audio formats found";
        container.appendChild(empty); return;
      }
      formats.forEach((fmt, i) => {
        const row = document.createElement("div");
        const disabled = fmt.conversion && !window.ffmpegAvailable;
        row.className = "format-row glass-panel animate-fade-up stagger-" + Math.min(i + 1, 8)
          + (disabled ? " format-row-disabled" : "");
        const iconName = disabled ? "lock" : "download";
        row.innerHTML = '<div class="format-row-left"><span class="quality-badge"></span><span class="format-label"></span></div>'
          + '<div class="format-row-right"><span class="format-size"></span><div class="download-icon"><i data-lucide="' + iconName + '"></i></div></div>';
        row.querySelector(".quality-badge").textContent = fmt.ext.toUpperCase();
        row.querySelector(".format-label").textContent = sanitizeText(fmt.label);
        row.querySelector(".format-size").textContent = fmt.size;
        if (disabled) {
          row.title = "Requires ffmpeg";
        } else {
          row.addEventListener("click", () => startDownload(fmt.format_id, "audio", fmt.ext, fmt.ext));
        }
        container.appendChild(row);
      });
      lucide.createIcons();
    }

    function renderThumbnailOptions(videoId) {
      const container = document.getElementById("thumb-options");
      container.innerHTML = "";
      const qualities = [
        { label: "Max Resolution", quality: "max", dimensions: "1280\u00d7720" },
        { label: "High Quality", quality: "hq", dimensions: "480\u00d7360" },
        { label: "Standard", quality: "low", dimensions: "120\u00d790" }
      ];
      qualities.forEach(q => {
        const card = document.createElement("div");
        card.className = "thumb-card glass-panel";
        card.innerHTML = '<div class="thumb-info"><span class="thumb-label"></span>'
          + '<span class="thumb-dims"></span></div>';
        card.querySelector(".thumb-label").textContent = q.label;
        card.querySelector(".thumb-dims").textContent = q.dimensions + " \u2022 JPG";
        const btn = document.createElement("button");
        btn.className = "glass-btn-accent thumb-dl-btn";
        btn.innerHTML = '<i data-lucide="download" style="width:14px;height:14px;"></i><span>Save</span>';
        btn.addEventListener("click", (e) => { e.stopPropagation(); downloadThumbnail(videoId, q.quality, btn); });
        card.appendChild(btn);
        container.appendChild(card);
      });
      lucide.createIcons();
    }

    // ─── Tab Switching ────────────────────────────────────────
    function switchTab(tabName) {
      const contents = { video: "tab-video-content", audio: "tab-audio-content", thumbnail: "tab-thumb-content" };
      Object.values(contents).forEach(id => {
        const el = document.getElementById(id);
        el.style.opacity = "0";
        setTimeout(() => el.classList.add("hidden"), 150);
      });
      setTimeout(() => {
        const target = document.getElementById(contents[tabName]);
        target.classList.remove("hidden");
        setTimeout(() => { target.style.opacity = "1"; }, 10);
      }, 160);
      document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.tab === tabName);
      });
    }

    // ─── Download Flow ────────────────────────────────────────
    function sanitizeClientFilename(name) {
      let s = name.replace(/[\\/*?:"<>|]/g, "").replace(/\.\./g, "").trim();
      return s.length > 120 ? s.substring(0, 120) : (s || "download");
    }

    async function startDownload(formatId, type, ext, audioFormat) {
      if (window.downloadInProgress) {
        showToast("A download is already in progress", "warning"); return;
      }
      window.downloadInProgress = true;
      window.abortController = new AbortController();

      const filename = sanitizeClientFilename(window.videoData ? window.videoData.title : "download");
      const title = window.videoData ? window.videoData.title : "download";

      // Update UI
      document.getElementById("dl-filename").textContent = sanitizeText(title);
      document.getElementById("dl-format").textContent = ext.toUpperCase() + " \u2022 " + type;
      document.getElementById("progress-fill").style.width = "0%";
      document.getElementById("progress-percent").textContent = "0%";
      document.getElementById("status-text").textContent = "Starting...";
      setState(STATES.DOWNLOADING);

      try {
        // Step 1: Start the download job (returns immediately with job_id)
        const response = await fetch(API_BASE + "/download", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            url: window.currentURL,
            format_id: formatId, ext: ext,
            filename: filename, type: type,
            audio_format: audioFormat
          }),
          signal: window.abortController.signal
        });

        if (!response.ok) {
          let errMsg = "Download failed.";
          try { const errData = await response.json(); errMsg = errData.error || errMsg; } catch (e) { }
          throw new Error(errMsg);
        }

        const jobData = await response.json();
        const jobId = jobData.job_id;
        window.currentJobId = jobId;

        // Step 2: Track progress via SSE until done or error
        await new Promise((resolve, reject) => {
          const es = new EventSource(API_BASE + "/progress/" + jobId);
          window.currentEventSource = es;
          es.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);
              updateProgressBar(data.progress);
              updateStatusText(data.status);
              if (data.status === "done") { es.close(); window.currentEventSource = null; resolve(); }
              else if (data.status === "error") { es.close(); window.currentEventSource = null; reject(new Error("Download failed on server.")); }
            } catch (e) { /* ignore parse errors */ }
          };
          es.onerror = () => { es.close(); window.currentEventSource = null; reject(new Error("Lost connection to server.")); };
        });

        // Step 3: Fetch the completed file
        const fileResp = await fetch(API_BASE + "/file/" + jobId, { signal: window.abortController.signal });
        if (!fileResp.ok) {
          let errMsg = "Could not retrieve file.";
          try { const errData = await fileResp.json(); errMsg = errData.error || errMsg; } catch (e) { }
          throw new Error(errMsg);
        }
        const blob = await fileResp.blob();
        triggerFileSave(blob, filename, ext);
        setDoneState(title, filename, ext);
        setState(STATES.DONE);

      } catch (err) {
        if (err.name === "AbortError") return;
        window.downloadInProgress = false;
        showError("Download failed: " + (err.message || "Unknown error"));
        setState(STATES.ERROR);
      } finally {
        window.downloadInProgress = false;
        if (window.currentEventSource) { window.currentEventSource.close(); window.currentEventSource = null; }
      }
    }

    // Progress tracking is now inline in startDownload via Promise-based SSE

    function triggerFileSave(blob, filename, ext) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename + "." + ext; a.style.display = "none";
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      setTimeout(() => URL.revokeObjectURL(url), 100);
    }

    async function downloadThumbnail(videoId, quality, btn) {
      const origHTML = btn.innerHTML;
      btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin" style="width:14px;height:14px;"></i><span>Saving...</span>';
      lucide.createIcons();
      try {
        const resp = await fetch(API_BASE + "/thumbnail?video_id=" + videoId + "&quality=" + quality);
        if (!resp.ok) throw new Error("Thumbnail fetch failed");
        const blob = await resp.blob();
        triggerFileSave(blob, videoId + "_" + quality, "jpg");
        btn.innerHTML = '<i data-lucide="check" style="width:14px;height:14px;"></i><span>Saved!</span>';
        lucide.createIcons();
        setTimeout(() => { btn.innerHTML = origHTML; lucide.createIcons(); }, 2000);
      } catch (e) {
        showToast("Could not download thumbnail", "error");
        btn.innerHTML = origHTML; lucide.createIcons();
      }
    }

    function updateProgressBar(percent) {
      const p = Math.min(100, Math.max(0, percent));
      document.getElementById("progress-fill").style.width = p + "%";
      document.getElementById("progress-percent").textContent = Math.floor(p) + "%";
    }

    function updateStatusText(status) {
      const labels = {
        starting: "Starting download...", downloading: "Downloading...",
        merging: "Merging audio and video tracks...", converting: "Converting to MP3...",
        done: "Complete!", error: "Error occurred"
      };
      document.getElementById("status-text").textContent = labels[status] || status;
    }

    function setDoneState(title, filename, ext) {
      document.getElementById("done-filename").textContent = filename + "." + ext;
      const svg = document.getElementById("success-svg");
      svg.classList.remove("checkmark-active");
      void svg.offsetWidth; // force reflow
      svg.classList.add("checkmark-active");
    }

    // ─── UI Helpers ───────────────────────────────────────────
    function showToast(message, type) {
      type = type || "info";
      const container = document.getElementById("toast-container");
      // Enforce max 3
      while (container.children.length >= 3) container.removeChild(container.firstChild);
      const toast = document.createElement("div");
      toast.className = "toast toast-" + type;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => {
        toast.classList.add("toast-hiding");
        setTimeout(() => { if (toast.parentNode) toast.parentNode.removeChild(toast); }, 300);
      }, 3000);
    }

    function showError(message) {
      document.getElementById("error-message").textContent = message;
    }

    function showSetupOverlay() { document.getElementById("setup-overlay").classList.remove("hidden"); }

    function hideSetupOverlay() {
      const overlay = document.getElementById("setup-overlay");
      overlay.style.opacity = "0";
      setTimeout(() => { overlay.classList.add("hidden"); overlay.style.opacity = ""; }, 300);
      showToast("Companion connected!", "success");
    }

    function showFFmpegBanner() { document.getElementById("ffmpeg-banner").classList.remove("hidden"); }
    function hideFFmpegBanner() { document.getElementById("ffmpeg-banner").classList.add("hidden"); }

    function animatePageIn() {
      document.body.style.opacity = "0";
      requestAnimationFrame(() => {
        document.body.style.transition = "opacity 0.4s ease";
        document.body.style.opacity = "1";
      });
    }

    // ─── Initialization ──────────────────────────────────────
    document.addEventListener("DOMContentLoaded", () => {
      animatePageIn();
      lucide.createIcons();

      // Input listeners
      const urlInput = document.getElementById("url-input");
      const fetchBtn = document.getElementById("fetch-btn");
      const pasteBtn = document.getElementById("paste-btn");
      const indicator = document.getElementById("input-indicator");

      urlInput.addEventListener("input", () => {
        indicator.classList.toggle("visible", isValidYouTubeURL(urlInput.value));
        hideInlineError();
      });
      urlInput.addEventListener("keydown", (e) => { if (e.key === "Enter") handleSubmit(); });
      fetchBtn.addEventListener("click", handleSubmit);
      pasteBtn.addEventListener("click", () => {
        navigator.clipboard.readText().then(text => {
          urlInput.value = text;
          indicator.classList.toggle("visible", isValidYouTubeURL(text));
          if (isValidYouTubeURL(text)) setTimeout(() => fetchVideoInfo(text), 300);
        }).catch(() => showToast("Allow clipboard access", "warning"));
      });

      // Tab listeners
      document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.addEventListener("click", () => switchTab(btn.dataset.tab));
      });

      // Button listeners
      document.getElementById("cancel-btn").addEventListener("click", () => {
        if (window.abortController) window.abortController.abort();
        if (window.currentEventSource) { window.currentEventSource.close(); window.currentEventSource = null; }
        window.downloadInProgress = false;
        showToast("Download cancelled", "info");
        setState(STATES.IDLE);
      });

      document.getElementById("btn-another").addEventListener("click", () => {
        window.videoData = null; window.currentURL = null; window.currentJobId = null;
        setState(STATES.IDLE);
        setTimeout(() => { const inp = document.getElementById("url-input"); if (inp) inp.focus(); }, 100);
      });

      document.getElementById("btn-same").addEventListener("click", () => { setState(STATES.READY); });
      document.getElementById("btn-tryagain").addEventListener("click", () => { setState(STATES.IDLE); });

      // Keyboard shortcuts
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && currentState === STATES.DOWNLOADING) {
          document.getElementById("cancel-btn").click();
        }
      });

      // Start companion check
      checkCompanion();
      retryInterval = setInterval(checkCompanion, 3000);
    });
  </script>
</body>

</html>